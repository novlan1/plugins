:::info 作者

novlan1

2025.8.25

:::

# 发布失败常见原因

## 1. pnpm-lock.yaml 未同步

报错如下：

```
 ERR_PNPM_OUTDATED_LOCKFILE  Cannot install with "frozen-lockfile" because pnpm-lock.yaml is not up to date with <ROOT>/package.json
Note that in CI environments this setting is true by default. If you still need to run install in such cases, use "pnpm install --no-frozen-lockfile"
    Failure reason:
```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/8/own_mike_6ZSYbBeGwTzsFn23.png" width="600" />

解决方法：

- 本地执行 `pnpm i`，然后提交 `pnpm-lock.yaml`

查看[示例流水线](https://devops.aow.com/console/pipeline/tip-h5/p-1e6b670b468d44feb55eb7ff618e0e6c/detail/b-1002dac8878247f18b60012b71b28a8d/executeDetail)。

## 2. 本地构建问题

构建失败具体原因就非常多了，比如下面这种 `src/component` 没更新的：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/8/own_mike_mRcefJHeMenG48hF.png" width="600" />

下面是小程序下使用了不支持的语法：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/8/own_mike_sNf6y7eX56df8WbS.png" width="600" />

下面是类型错误导致的编译失败：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_TjtrTfDXKnTThp3i.png" width="600" />

示例流水线

1. [文件问题](https://devops.aow.com/console/pipeline/tip-h5/p-638294e908a74e4193e7104eca2dd69e/detail/b-0a7babc335dd4742a8e50a2f6c758757/executeDetail)
2. [语法问题](https://devops.aow.com/console/pipeline/tip-h5/p-20e9bf15e6f444c2ac74984cf0274033/detail/b-5107fc17991b4cba9913783d4a38da0d/executeDetail)
3. [类型错误](https://devops.aow.com/console/pipeline/tip-h5/p-cb8fadb8445143d992111e1ba09df04f/detail/b-f4f639e591764fd3955ecc1658065f10/executeDetail)

解决方法：

- 本地解决问题，执行 `npm run build` 或者 `npm run build:mp` 等命令，没问题后提交

## 3. 分支名不合法

如果分支名中包含“[零宽空格](https://zh.wikipedia.org/wiki/%E9%9B%B6%E5%AE%BD%E7%A9%BA%E6%A0%BC)”，会导致发布失败。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_iny5iBzFG2ZtxjJ3.png" width="600" />

下面的这个分支名称，就包含了“零宽空格”，在某些 IDE 下不可见，复制到其他地方后可见。

```sh
feature/story-map-​whitelist​
```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_hHFzreYfTmwQZeFM.gif" width="500" />

这种“零宽空格”在 `base64.encode` 时会失败，即 `btoa`，报错如下：

```
The string to be encoded contains characters outside of the Latin1 range
```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_smaEdxQwDZK5e7sG.png" width="600" />

解决方法：

- 使用不包含“零宽空格”的新分支，重新发布

## 4. 内存溢出

报错如下：

```
[1125357:0x5ba7c80]    35259 ms: Scavenge 2029.3 (2079.8) -> 2024.7 (2098.1) MB, 9.01 / 0.00 ms  (average mu = 0.622, current mu = 0.479) allocation failure; 


<--- JS stacktrace --->

FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
----- Native stack trace -----

 1: 0xb8ced1 node::OOMErrorHandler(char const*, v8::OOMDetails const&) [/root/.nvm/versions/node/v20.18.0/bin/node]
 2: 0xf06460 v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, v8::OOMDetails const&) [/root/.nvm/versions/node/v20.18.0/bin/node]
 3: 0xf06747 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, v8::OOMDetails const&) [/root/.nvm/versions/node/v20.18.0/bin/node]
 4: 0x11182e5  [/root/.nvm/versions/node/v20.18.0/bin/node]
 5: 0x1130168 v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [/root/.nvm/versions/node/v20.18.0/bin/node]
 6: 0x1106281 v8::internal::HeapAllocator::AllocateRawWithLightRetrySlowPath(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [/root/.nvm/versions/node/v20.18.0/bin/node]
 7: 0x1107415 v8::internal::HeapAllocator::AllocateRawWithRetryOrFailSlowPath(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [/root/.nvm/versions/node/v20.18.0/bin/node]
 8: 0x10e4a66 v8::internal::Factory::NewFillerObject(int, v8::internal::AllocationAlignment, v8::internal::AllocationType, v8::internal::AllocationOrigin) [/root/.nvm/versions/node/v20.18.0/bin/node]
 9: 0x1540896 v8::internal::Runtime_AllocateInYoungGeneration(int, unsigned long*, v8::internal::Isolate*) [/root/.nvm/versions/node/v20.18.0/bin/node]
10: 0x7f5493ed9ef6 
```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_S5RxebQHHMm6yc6d.png" width="600" />

解决方法有多种，可以在之前的 `build` 命令前加上 `cross-env NODE_OPTIONS=--max_old_space_size=8192`，如：

```diff
- "build": "vue-cli-service build",
+ "build": "cross-env NODE_OPTIONS=--max_old_space_size=8192 vue-cli-service build",
```

如果是 Vue2 项目，可以参考[这里](https://stackoverflow.com/questions/55258355/vue-clis-type-checking-service-ignores-memory-limits)，修改 `vue.config.js` 配置。

```js
const vueBaseConfig = getWebpackBaseConfig({
  isUseVueLoader: true,
  isVue3: false,
  useXSS: true,
});

module.exports = merge(someConfig, {
  chainWebpack: (config) => {
    config.plugin('fork-ts-checker').tap((args) => {
      args[0].memoryLimit = 8192; 
      return args;
    });
  },
});
```

查看[示例流水线](https://devops.aow.com/console/pipeline/tip-h5/p-87aaa14d7d8142d9b420f7fcc18cf6fe/detail/b-62e731f1ea1e4dbb9e9a8aa0f2daa31d/executeDetail)。

## 5. “微信小程序CI”蓝盾插件

2025.9.15 更新

`browserslist` 这个生态包在周末进行了不符合 `semver` 语义的破坏性升级（[v4.26.0](https://www.npmjs.com/package/browserslist?activeTab=versions)），造成一些报错，类似这个 issue：[https://github.com/browserslist/browserslist/issues/904](https://github.com/browserslist/browserslist/issues/904)。

锁定 `v4.25.4` 可解决，“微信小程序CI”蓝盾插件[最新版本](https://git.aow.com/bkdevops-plugins/miniprogrameCI/commit/c517ee0e02b9f44e405923950121ac3e4e0ffb44)支持。

查看[示例流水线](https://devops.aow.com/console/pipeline/tip-h5/p-2f8175fd04d24690b137cba8bbe2fe0d/detail/b-441b257932c24ed082e3faea86eeac49/executeDetail)。

## 6. postcss 包不兼容

包不兼容，报错如下：

```
error  in ./node_modules/.pnpm/vant@2.13.9_vue@2.7.16/node_modules/vant/lib/toast/index.css

Syntax Error: Error: PostCSS plugin postcss-uniapp-plugin requires PostCSS 8.
Migration guide for end-users:
https://github.com/postcss/postcss/wiki/PostCSS-8-for-end-users


 @ ./node_modules/.pnpm/vant@2.13.9_vue@2.7.16/node_modules/vant/lib/toast/index.css 4:14-606
 @ ./src/comm/widget/toast.js
 @ ./src/project/uniapp-igame-lolm/main-h5.js
 @ ./src/project/uniapp-igame-lolm/main.js
 @ multi ./src/project/uniapp-igame-lolm/main.js
 ```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/10/own_mike_RapSxib4t3dJQkMW.png" width="600" />

快速解决方案：

```bash
pnpm i postcss@7 -D
```

查看[示例流水线](https://devops.aow.com/console/pipeline/tip-h5/p-87aaa14d7d8142d9b420f7fcc18cf6fe/detail/b-62e731f1ea1e4dbb9e9a8aa0f2daa31d/executeDetail)。

## 7. vue-router 报错

```
 ERROR  [commonjs--resolver] Cannot find module '/data/landun/workspace/p-d463f220131b4224b0bc296967dbccfc/src/node_modules/vue-router/dist/vue-router.esm-bundler.js'

  at createEsmNotFoundErr (node:internal/modules/cjs/loader:1262:15)
  at finalizeEsmResolution (node:internal/modules/cjs/loader:1250:15)
  at resolveExports (node:internal/modules/cjs/loader:634:14)
  at Module._findPath (node:internal/modules/cjs/loader:724:31)
  at Module._resolveFilename (node:internal/modules/cjs/loader:1211:27)
  at Module._resolveFilename (node_modules/.pnpm/module-alias@2.2.3/node_modules/module-alias/index.js:49:29)
  at Function.resolve (node:internal/modules/helpers:190:19)
  at resolveBuiltIn (node_modules/.pnpm/@dcloudio+uni-cli-shared@3.0.0-4020920240930001_postcss@8.4.49_rollup@4.28.1_vue@3.5.13_typescript@5.5.4_/node_modules/@dcloudio/uni-cli-shared/dist/resolve.js:97:20)
```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/10/own_mike_ZdwNih5YwdJ3yQYb.png" width="600" />

解决方案

锁定 `4.5` 版本，不要用 `4.6.0`。

参考：https://github.com/vuejs/router/issues/2569
