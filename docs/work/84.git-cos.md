:::info 作者

novlan1

2025.9.19
:::

# Git 仓库文件自动同步 COS

仓库地址：https://git.aow.com/pmd-mobile/pmd-h5/cos

## 1. 目标

1. 提高效率，自动同步、自动刷新 CDN
2. 收拢权限，提升安全性
3. 统一管理，方便维护

## 2. 原理

### 2.1. 自动同步

1. 监听 `git push`
2. 自动同步到 COS
3. 自动更新 CDN 缓存

### 2.2. 自动复制

海外域名支持多语言自动复制，具体规则如下：

1. 将当前业务的某语言作为基准
2. 将基准语言目录下的文件，复制到其他语言目录。当其他语言目录相应位置已有文件时，忽略
3. 将当前域名下下所有文件，复制到国内域名下

以三角洲海外来说：

1. 将 `cdn.dfpcevos.igame.tencent.com/os-delta-match/zh-cn` 复制到 `cdn.dfpcevos.igame.tencent.com/os-delta-match/en` 和 `cdn.dfpcevos.igame.tencent.com/os-delta-match/zh-hant`
2. 将 `cdn.dfpcevos.igame.tencent.com/os-delta-match` 复制到 `image-1251917893.file.myqcloud.com/os-delta-match`

由于历史原因，`cdn.nes.sgameglobal.com` 域名下的 HoK 赛事、商家，同步规则与上不同，具体如下：

1. 将 `cdn.nes.sgameglobal.com/hok-match` 复制到 `cdn.nes.sgameglobal.com/hor-match-en` 和 `cdn.nes.sgameglobal.com/hok-match-fr` 等等
2. 将 `cdn.nes.sgameglobal.com/hor-match*` 复制到 `image-1251917893.file.myqcloud.com/hor-match*`

## 3. 目录说明

Git 目录和 CDN 链接的对应关系如下：

|<p style="width: 100px">Git 目录</p>|<p style="width: 100px">CDN 链接</p>|<p style="width: 280px">COS 链接</p>|<p style="width: 100px">对应业务</p>|
|---|---|---|---|
|cdn.dfpcevos.igame.tencent.com|cdn.dfpcevos.igame.tencent.com|cdn-1377130694.cos.ap-singapore.myqcloud.com|海外三角洲行动|
|cdn.esports.tencent.com|cdn.esports.tencent.com|cdn-esports-1320306881.cos.ap-singapore.myqcloud.com|游戏人生通用海外赛事|
|cdn.nes.sgameglobal.com|cdn.nes.sgameglobal.com|nes-pro-1310788819.cos.ap-singapore.myqcloud.com|HoK 赛事、商家|
|download.ecafe.game|download.ecafe.game|cdn-download-cos-1320306881.cos.ap-singapore.myqcloud.com|海外网吧|
|image-1251917893|image-1251917893.file.myqcloud.com|image-1251917893.cos.ap-guangzhou.myqcloud.com|国内各业务|

## 4. 规范

出海业务目录规范

1. 业务目录以 `os-` 开头，比如 `os-delta-match`，方便跟国内区分
2. 目录结构为 `域名/业务/语言/类型/文件`，如 `cdn.dfpcevos.igame.tencent.com/os-delta-match/zh-cn/images/xxx`

## 5. 自动压缩

当在 `cos.git` 上提交图片文件时，会通过 `husky` 的 `pre-commit` 脚本尝试进行压缩。

开发者需要提前在 `.env.local` 中写入 `tinypng` 平台的 API 密钥，获取地址[在这里](https://tinify.com/dashboard/api)。

```bash
TINIFY_API_KEY=abcdefg
```

如何想忽略这一步，可以使用 `--no-verify` 参数，如：

```bash
git commit -m"feat: add images" --no-verify
```

效果如下：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_NMt6GT7Ct8dsJWXt.png" width="600" />

## 6. 更新须知

1. Git 目录与COS目录一一对应，目录结构保持一致
2. 更新前必须确认好，避免覆盖，影响现网
3. 必须提 MR
4. 文件限制：2025.9.19 开始无限制

## 7. 对比 Next Admin

|维度|[Git 仓库自动同步](https://git.aow.com/pmd-mobile/pmd-h5/cos/)|[Next Admin](https://novlan1.github.io/docs/next-admin/image/)|
|---|---|---|
|CDN 刷新|✅|✅|
|多语言目录复制|✅|❌|
|在线压缩|✅|✅|
|易用性|中|高|
|面向人群|研发|任何人|

## 8. 国内业务迁移

之前国内 COS 管理比较混乱，后面逐步使用本工具进行上传，方便查看记录、权限管理。下面是已迁移的业务：

|业务|路径|
|---|---|
|掼蛋赛事|image-1251917893/guandan-match|
|国内三角洲赛事|image-1251917893/tip-project/delta/match|
|和平赛事|image-1251917893/tip-project/pubg/pubg-match|
|无畏赛事|image-1251917893/tip-project/valorant|

## 9. FAQ

### 9.1. 如何判断是否上传成功

企业微信群有通知，或者在蓝盾查看执行记录：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_tdNDanMypbN7dhSa.png" width="500">

<br />

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_xT7btDbhbMeWYNaC.png" width="600" />

### 9.2. 代码合并后未同步到 COS

检查是否提交了太多文件，造成变量长度超出蓝盾限制。[类似](https://devops.aow.com/console/pipeline/tip-h5/p-13dfc9582e754af9834437e6a2244316/detail/b-ca7ef51d05c9486c8a02bf61590cb32a/executeDetail)：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_xXEshAenWEhzQ6eD.png" width="600"/>

解决方案为手动触发一次，`UPLOAD_ALL_FILE_FROM_DIR` 设置为要上传的目录名称，如 `image-1251917893/delta-match/css`：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_NzH7Rz7wmBQww6EF.png" width="600"/>

### 9.3. 新增语言目录如何同步

如果中途新增了一个语言目录，然后提交，那么历史的中文目录中的文件不会自动同步。这是因为同步机制是根据 `git diff` 来的。

解决方案为手动触发一次，`UPLOAD_ALL_FILE_FROM_DIR` 设置为对应的中文目录，如 `cdn.partner.esports.pubgmobile.com/os-pubgm/zh`：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_NzH7Rz7wmBQww6EF.png" width="600"/>

### 9.4. 为什么不把海外项目的 COS 桶和 CDN 放一起

方便成本分摊，及项目组要求

### 9.5. 如何获取 CDN 链接

执行 `npm run cdn <File>` 命令，示例如下：

```
npm run cdn image-1251917893/igame/redirect/pc.js
```

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_ZhycpPw7yfiwx27s.png" width="600" />

### 9.6. 流水线地址

[这里](https://devops.aow.com/console/pipeline/tip-h5/p-13dfc9582e754af9834437e6a2244316/history/history)。
