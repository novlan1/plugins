:::info 作者

novlan1

2025.9.3

:::

# 小程序发布指南

这里说的小程序“发布”指的是通过 [miniprogram-cli](https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html) 进行**上传和预览**。

## 1. 研发平台

先简单介绍下前端研发平台，平台地址为：https://mobile.aow.com/rd-platform-web/

主要包含CI/CD、公共组件管理、白名单管理、域名管理、COS管理等功能。

工程架构上，主要分为两级：

- 主工程。每个 Git 仓库为一个主工程
- 子工程。主工程下可以有多个子工程，可以看作定制化的 `monorepo`

```
- main-project
 - src
  - project
    - sub-project
```

## 2. 小程序 CI 设计思想

分支和流水线

1. 子工程的不同分支，会对应不同的机器人，以及独立的流水线
2. 只有 `release` 分支可以发布正式环境，其他分支只能发布测试环境
3. 可以接入 [debug-popup 组件](https://novlan1.github.io/press-plus/components/press/press-debug-popup.html) 进行后台环境的动态切换

配置

1. 研发平台配置只是中间层，所有信息都存储在七彩石
2. 七彩石[配置地址](https://rainbow.aow.com/console/7b1fbda4-dc30-4641-bab2-32e34e6435f1/Default/list?group_id=2045027&group_name=devops_mp_ci&tab=config)

机器人

1. 由于[微信侧限制](https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html)，机器人范围只能为`1-30`
2. 一般业务同时在测的需求应该不会超过`28`个，基本满足需求

对比 H5 发布

| <p style="width:70px">维度</p> | H5                     | 小程序                                 | 说明                     |
| ------------------------------ | ---------------------- | -------------------------------------- | ------------------------ |
| 流水线                         | 一个工程共用一条流水线 | 不同子工程的不同分支，都独立一条流水线 | 空间换时间，构建速度更快 |
| 发布本质                       | 资源上传到COS或集群    | 资源上传到微信后台                     | 小程序需额外提审和发布   |

## 3. 小程序接入

新的小程序接入可以按照以下步骤操作。

1. 点击工程“详情”，会看到子工程列表

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_sT4MTQbze32MFpxw.png" width="600" />

2. 点击子工程名称，进入子工程详情页面

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_yJNiXWny68pwTXRB.png" width="600" />

3. 切换到“小程序CI”页签，点击“立即接入”

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_4rNs7CxjGJKnETS2.png" width="600" />

4. 填写基本信息，点击确定进行提交

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_DXS3DRfCeaQdNj47.png" width="600" />

5. 回到子工程下“小程序CI”页签，点击"新增发布"

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_enar54fQwCBfDQyE.png" width="600" />

6. 填写机器人、分支、环境等信息

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_Zhw54syDxJbErChH.png" width="600" />

## 4. 新分支接入

微信限制CI机器人最多为[30个](https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html)。

### 4.1. 新增机器人

在当前项目接入分支数小于30个时，可以点击“新增发布”，新增分支即可。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_ZKhbfJZNGAwXzx3N.png" width="600" />

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_Zhw54syDxJbErChH.png" width="600" />

配置完成后，会生成一条唯一的流水线，并设置了当前工程、子工程、分支、机器人、发布环境等信息。

### 4.2. 修改之前机器人

如果当前子工程接入分支数已经有30个了，可以修改已经不用的分支。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_yDkxBAXAyNfw63Tx.png" width="600" />

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_hfpSMDSiBHTSyM5Q.png" width="600" />

## 5. 小程序发布

可以在“小程序CI”页签下点击“微信小程序构建”，或者“QQ小程序构建”进行构建。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_azHttCHiPJTS35hc.png" width="600" />

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_8dYe4y25QhBEhryj.png" width="600" />

构建正式环境需要填写发布原因。

⚠️ 注意，如果要真正发布小程序的话，还要在[微信开发者后台](https://mp.weixin.qq.com/)进行提审操作。

## 6. 发布通知

发布完成后，会在CI群内有对应的通知。

通知不仅有本次发布的基本信息，还有包体积统计、二维码信息。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_Fdd64k2CR4HmeHzx.png" width="600" />

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_TAJMdX8jrAhwy5CN.png" width="300" />

接入分发插件的小程序，还有引用错误监控。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_ZMRt5em3ikE3dMy5.png" width="600" />

## 7. FAQ

### 7.1. 上传的版本号从何而来，如何修改

读的是 `package.json` 的 `version` 字段，直接修改这个字段的值即可。
