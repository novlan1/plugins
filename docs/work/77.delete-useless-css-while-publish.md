:::info 作者

novlan1

2025.9.11
:::

# 上云发布删除多余文件

## 1. 冗余文件删除

之前的发布，将静态文件上传CDN后，没删干净，仍然保留了CSS文件、字体文件，这次一起删除了。

效果对比如下，减少了 `99.2%` 的体积。之前：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_XbxcGHmrAnT66bse.png" width="600" />

之后：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_JApb8JtpH4W8PkJs.png" width="600" />

方式：

```diff
- find "${BUILD_DESC_PATH}/" -name "*.js" | xargs rm -rf
- find "${BUILD_DESC_PATH}/" -name "*.js.map" | xargs rm -rf
- find "${BUILD_DESC_PATH}/" -name "*.gz" | xargs rm -rf

+ find "${BUILD_DESC_PATH}/" -type f -not -name "*.html" -print0 | xargs -0 rm -rf
+ find ./ -type d -empty -print0 | xargs -0 rmdir
```

删除多余文件后，提升了构建并推送镜像的速度，加速构建发布。

## 2. 非必要文件不上传

另外，当前构建会将非 `html` 文件都上传到CDN中，这里其实漏了 `sourcemap` 和 `tar` 压缩文件等，这些都是没必要的。

之前配置：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_THJwEiW3JpX4DMmM.png" width="600" />

要改成：

```js
\.(html|map|tar)$
```

## 3. 存量文件处理

对于上云发布的历史冗余文件，需要手动删除。删除后，提升了构建速度。

以 `h5-test.igame.qq.com` 为例，镜像文件大小从之前 `2.9G` 降低到了 `11M`，节省了超 `99.6%`。

之前：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_ZGtwwD5BbKBxnK3t.png" width="400" />

之后：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_yMaMa2pjkthr4Gdc.png" width="400" />

发布耗时大幅缩减，以某项目为例，之前需要`6分42秒`。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_hahYNnAXKF6RN75M.png" width="600" />

现在只需要`4分30秒`，节省了`132秒`，约 `32.8%`。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/9/own_mike_CfsK6sYchNeeRrBc.png" width="600" />
